dockerfileとは→Dockerイメージを作成するための手順を記したもの

必要なもの
ベースイメージ(FROM)
ROS2 Humbleのインストール
--[Realsense-SDK]のインストール-
[UT_ARM_ROS2]のインストール
## Dockerfile作成
以下のサイトを参考に行った
[Docker・rocker でGUIとGPUが使えるROS 2 Humbleの環境を作る](https://qiita.com/porizou1/items/76980fbd0d1675eecf7f)
###  エラー1 デーモンへのアクセス権限がなかった
エラー文
```
ERROR: permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Head "http://%2Fvar%2Frun%2Fdocker.sock/_ping": dial unix /var/run/docker.sock: connect: permission denied
```

```
$ sudo usermod -aG docker $USER
$ newgrp docker
# 確認
$ docker run hello-world
```

これでsudo権限無しでdockerコマンドを使用可能

###  エラー2 ビルドエラー
```
$ docker build -t ros2_humble .
```

エラー文
```
[+] Building 3.5s (20/21)                                        docker:default
 => [internal] load build definition from Dockerfile                       0.0s
 => => transferring dockerfile: 1.79kB                                     0.0s
 => WARN: NoEmptyContinuation: Empty continuation line (line 31)           0.0s
 => WARN: NoEmptyContinuation: Empty continuation line (line 35)           0.0s
 => WARN: NoEmptyContinuation: Empty continuation line (line 42)           0.0s
 => WARN: NoEmptyContinuation: Empty continuation line (line 47)           0.0s
 => WARN: NoEmptyContinuation: Empty continuation line (line 69)           0.0s
 => [internal] load metadata for docker.io/nvidia/opengl:base-ubuntu22.04  3.4s
 => [internal] load .dockerignore                                          0.0s
 => => transferring context: 2B                                            0.0s
 => CANCELED [ 1/17] FROM docker.io/nvidia/opengl:base-ubuntu22.04@sha256  0.0s
 => => resolve docker.io/nvidia/opengl:base-ubuntu22.04@sha256:06cd5ba14f  0.0s
 => => sha256:06cd5ba14facded1df3ff6924df460e6a889afb2fdf 1.16kB / 1.16kB  0.0s
 => => sha256:02349b2d9d36257ee366a6dd4988bfd297cb70ca840 4.25kB / 4.25kB  0.0s
 => [internal] load build context                                          0.0s
 => => transferring context: 2B                                            0.0s
 => CACHED [ 2/17] RUN apt-get update && apt-get install -y     curl       0.0s
 => CACHED [ 3/17] RUN curl -s https://raw.githubusercontent.com/ros/rosd  0.0s
 => CACHED [ 4/17] RUN apt-get update && apt-get install -y     ros-humbl  0.0s
 => CACHED [ 5/17] RUN apt-get install -y python3-colcon-common-extension  0.0s
 => CACHED [ 6/17] RUN apt-get install -y ros-humble-rqt-*                 0.0s
 => CACHED [ 7/17] RUN apt-get install python3-rosdep2                     0.0s
 => CACHED [ 8/17] RUN rosdep init && rosdep update                        0.0s
 => CACHED [ 9/17] RUN mkdir -p ~/worksp/utra_ws/src                       0.0s
 => CACHED [10/17] WORKDIR /root/worksp/utra_ws                            0.0s
 => CACHED [11/17] RUN /bin/bash -c '. /opt/ros/humble/setup.bash; colcon  0.0s
 => CACHED [12/17] WORKDIR /root/worksp/utra_ws/src                        0.0s
 => CACHED [13/17] RUN git clone -b main https://github.com/UmbraTek/ut_a  0.0s
 => CACHED [14/17] WORKDIR /root/worksp/utra_ws                            0.0s
 => CACHED [15/17] RUN rosdep install --ignore-src --from-paths src --ros  0.0s
 => ERROR [16/17] COPY ./ros_entrypoint.sh /                               0.0s
------
 > [16/17] COPY ./ros_entrypoint.sh /:
------

 5 warnings found (use docker --debug to expand):
 - NoEmptyContinuation: Empty continuation line (line 31)
 - NoEmptyContinuation: Empty continuation line (line 35)
 - NoEmptyContinuation: Empty continuation line (line 42)
 - NoEmptyContinuation: Empty continuation line (line 47)
 - NoEmptyContinuation: Empty continuation line (line 69)
Dockerfile:81
--------------------
  79 |     # エントリーポイントを設定
  80 |     
  81 | >>> COPY ./ros_entrypoint.sh /
  82 |     
  83 |     RUN chmod +x /ros_entrypoint.sh
--------------------
ERROR: failed to solve: failed to compute cache key: failed to calculate checksum of ref ca7a94a3-f228-47a3-8174-58ab65127b94::x2axcr9lcxbczrco4vmtqu4st: "/ros_entrypoint.sh": not found

```

エントリーポイントファイルを作り忘れてた
~/worksp/ros_entrypoint.sh
```
sudo chmod +x ros_entrypoint.sh
```

sourceはDockerfile内で実行されないためエントリーポイントファイルに移す

### 最終的なDockerfile
```
# ベースイメージの設定

FROM nvidia/opengl:base-ubuntu22.04

# 環境変数の設定

ENV DEBIAN_FRONTEND=noninteractive

# 対話モード無効

ENV __NV_PRIME_RENDER_OFFLOAD=1

ENV __GLX_VENDOR_LIBRARY_NAME=nvidia

# GPU利用

# 必要なパッケージのインストール

RUN apt-get update && apt-get install -y \

curl \

gnupg \

lsb-release \

git \

python3-pip

# ROSのリポジトリをsource listに追加

ENV UBUNTU_CODENAME=focal

RUN curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - \

&& echo "deb http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list

# ROS2のインストール

RUN apt-get update && apt-get install -y \

ros-humble-desktop

# colconのインストール

RUN apt-get install -y python3-colcon-common-extensions \

python3-vcstool

# rqtのプラグインをインストール

RUN apt-get install -y ros-humble-rqt-*

# rosdepインストール

# ament-cmakeはutraインストール似必要

RUN apt-get update && apt-get install -y python3-rosdep2 ros-humble-ament-cmake

RUN if [ ! -f /etc/ros/rosdep/sources.list.d/20-default.list ]; \
then rosdep init; fi && rosdep update

# ワークスペースの作成

RUN mkdir -p ~/worksp/utra_ws/src

# UTRA_ROS2のクローン

WORKDIR /root/worksp/utra_ws/src

RUN git clone -b master https://github.com/UmbraTek/ut_arm_ros2.git \

&& rosdep update

WORKDIR /root/worksp/utra_ws

RUN rosdep install --ignore-src --from-paths src --rosdistro humble -y && \

/bin/bash -c "source /opt/ros/humble/setup.bash && colcon build"

# エントリーポイントを設定

COPY ./ros_entrypoint.sh /

RUN chmod +x /ros_entrypoint.sh

ENTRYPOINT ["/ros_entrypoint.sh"]

# コマンドを設定

CMD ["bash"]
```

```
FROM nvidia/opengl:base-ubuntu22.04

  

# Set environment variables

ENV DEBIAN_FRONTEND=noninteractive

ENV __NV_PRIME_RENDER_OFFLOAD=1

ENV __GLX_VENDOR_LIBRARY_NAME=nvidia

  

# [CHANGED] 追加: 後段の可読性のため

ARG ROS_DISTRO=humble

  

# Update and install necessary packages

RUN apt-get update && apt-get install -y \

curl \

gnupg \

lsb-release \

git \

python3-pip \

cmake \

git-all \

build-essential \

&& rm -rf /var/lib/apt/lists/*

  

# Add the ROS repository to the source list

ENV UBUNTU_CODENAME=focal

  

RUN curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add - \

&& echo "deb http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list

  

  

# install ROS2

RUN apt-get update && apt-get install -y \

ros-humble-desktop

  

# install colcon

RUN apt-get install -y python3-colcon-common-extensions \

python3-vcstool

  

# install rqt plugins

RUN apt-get install -y ros-humble-rqt-*

  

# install rosdep

# ament-cmake is required for rosdep

  

RUN apt-get update && apt-get install -y python3-rosdep2 ros-humble-ament-cmake

# [CHANGED] バックスラッシュの後のスペース除去 & そのままでもOKだが堅牢化

RUN if [ ! -f /etc/ros/rosdep/sources.list.d/20-default.list ]; \

then rosdep init; fi && rosdep update

  

# [CHANGED] ワークスペースを /ros2_ws に統一（~/home/... は誤りになりやすい）

ENV WS_DIR="/ros2_ws"

WORKDIR ${WS_DIR}

RUN mkdir -p ${WS_DIR}/rs_ws/src

WORKDIR ${WS_DIR}/rs_ws/src

  

# install realsense2 packages（apt 導入。別WSは不要）

RUN apt-get update \

&& apt-get install -y \

ros-${ROS_DISTRO}-librealsense2* \

ros-${ROS_DISTRO}-realsense2-* \

&& rm -rf /var/lib/apt/lists/*

  

# [CHANGED] UTRA のソースは /ros2_ws/src に配置

WORKDIR ${WS_DIR}

RUN mkdir -p ${WS_DIR}/utra_ws/src

WORKDIR ${WS_DIR}/utra_ws/src

# [CHANGED] ブランチは一般に main

RUN git clone -b master https://github.com/UmbraTek/ut_arm_ros2.git

  

# [CHANGED] 依存解決は WS 直下で。絶対パスを渡し、GUIキーはスキップ。--merge-install を使用

WORKDIR ${WS_DIR}/utra_ws

RUN rosdep install --ignore-src --from-paths src --rosdistro humble -y && \

/bin/bash -c "source /opt/ros/humble/setup.bash && colcon build"

  
  

# set up entrypoint script

COPY ./ros_entrypoint.sh /

RUN chmod +x /ros_entrypoint.sh

ENTRYPOINT ["/ros_entrypoint.sh"]

  

# コマンドを設定

CMD ["bash"]
```

なぜかament-cmakeが入っていなかったため追加でインストールしている

### Rockerインストール
```
$ sudo apt update && sudo apt install curl gnupg lsb-release
$ sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
$ echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(source /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
$ sudo apt update
$ sudo apt-get install python3-rocker
```
