# systemctlによる自動起動設定ガイド



Raspberry Pi起動時に `setup_cam_and_led.sh` を自動実行するための設定手順

  

---

  

## インストール手順

  

### 1. serviceファイルをsystemdディレクトリにコピー

  

```bash

sudo cp /home/hayashi-rpi/imaging_driver/run_imaging.service /etc/systemd/system/

```

  

### 2. systemdをリロード

  

```bash

sudo systemctl daemon-reload

```

  

### 3. 自動起動を有効化

  

```bash

sudo systemctl enable run_imaging.service

```

  

### 4. 今すぐ開始（テスト）

  

```bash

sudo systemctl start run_imaging.service

```

  

---

  

## Ctrl+Cの代わりの操作

  

| 手動実行時 | systemctl時 |

|-----------|-------------|

| `Ctrl+C` | `sudo systemctl stop run_imaging.service` |

  

---

  

## 動作の仕組み

  

- `systemctl stop` を実行すると、**SIGTERM** がスクリプトに送られます

- スクリプトは `trap cleanup EXIT TERM` で **SIGTERM** を捕捉しているので、LEDの停止処理が正しく実行されます

- `KillMode=mixed` により、メインプロセスにSIGTERM、子プロセスにもシグナルが送られます

  

---

  

## 便利なコマンド一覧

  

### ステータス確認

  

```bash

sudo systemctl status run_imaging.service

```

  

### ログ確認（リアルタイム）

  

```bash

$ sudo journalctl -u run_imaging.service -f

```

  

### ログ確認（全履歴）

  

```bash

$ sudo journalctl -u run_imaging.service

```

  

### サービス停止

  

```bash

$ sudo systemctl stop run_imaging.service

```

  

### サービス再起動

  

```bash

sudo systemctl restart run_imaging.service

```

  

### 自動起動無効化

  

```bash

sudo systemctl disable run_imaging.service

```

  

---

  

## serviceファイルの内容

  

`/home/hayashi-rpi/imaging_driver/run_imaging.service`

  

```ini

[Unit]

Description=Imaging service for LBM tactile sensing

After=multi-user.target network.target

  

[Service]

Type=simple

WorkingDirectory=/home/hayashi-rpi/imaging_driver

ExecStart=/home/hayashi-rpi/imaging_driver/bash_scripts/setup_cam_and_led.sh

ExecStop=/bin/kill -TERM $MAINPID

Restart=on-failure

RestartSec=5

KillMode=mixed

KillSignal=SIGTERM

TimeoutStopSec=10

StandardOutput=journal

StandardError=journal

User=hayashi-rpi

  

[Install]

WantedBy=multi-user.target

```

  

### 各設定の説明

  

| 設定 | 説明 |

|------|------|

| `Type=simple` | ExecStartで指定したプロセスがメインプロセス |

| `KillMode=mixed` | メインプロセスにSIGTERM、子プロセスにSIGKILL |

| `KillSignal=SIGTERM` | 停止時にSIGTERMを送信 |

| `Restart=on-failure` | 異常終了時に自動再起動 |

| `RestartSec=5` | 再起動まで5秒待機 |

| `TimeoutStopSec=10` | 停止処理のタイムアウト10秒 |

  

---

  

## トラブルシューティング

  

### サービスが起動しない場合

  

```bash

# 詳細なエラーログを確認

sudo journalctl -u run_imaging.service -n 50 --no-pager

  

# serviceファイルの構文チェック

sudo systemd-analyze verify /etc/systemd/system/run_imaging.service

```

  

### LEDが正しく停止しない場合

  

```bash

# LEDプロセスを手動で確認

ps aux | grep ws2812

  

# 手動で停止

sudo pkill -f ws2812.py

```

  

### 設定変更後

  

serviceファイルを編集した後は、必ず以下を実行：

  

```bash

sudo systemctl daemon-reload

sudo systemctl restart run_imaging.service

```

---

# 接触検出アルゴリズム（固定閾値法）

## 1. 基準画像の構築

最初の $n_0$ フレームの平均を基準画像 $I_0$ とする：

$$I_0 = \frac{1}{n_0} \sum_{t=1}^{n_0} I_t$$

## 2. 差分画像の計算

基準画像にガウシアンブラーを適用し、現フレームとの差分を計算：

$$D_t = \frac{I_t - G_\sigma(I_0)}{255} + 0.5$$

ここで $G_\sigma$ はカーネルサイズ $k$、標準偏差 $\sigma$ のガウシアンフィルタ。

## 3. エネルギーの計算

差分画像の0.5（無変化）からの偏差の平均をエネルギーとする：

$$E_t = \frac{1}{N} \sum_{x,y} |D_t(x,y) - 0.5|$$

ここで $N$ は画素数。

## 4. 接触判定

固定閾値 $T$ を用いて判定：

$$\text{State}_t = \begin{cases} \text{CONTACT} & \text{if } E_t > T \\ \text{NON\_CONTACT} & \text{otherwise} \end{cases}$$

## パラメータ一覧

| 記号 | コード変数 | 説明 |
|------|-----------|------|
| $n_0$ | `n0_frames` | 基準画像構築に使うフレーム数 |
| $T$ | `threshold` | 接触判定の閾値 |
| $k$ | `ksize` | ガウシアンフィルタのカーネルサイズ |
| $\sigma$ | `sigma` | ガウシアンフィルタの標準偏差 |

## imaging_driver同期用コマンド
メインPCで実行
```bash
$ rsync -avz --progress -e 'ssh -p 65535' hayashi-rpi@imaging.local:/home/hayashi-rpi/imaging_driver/ /home/hayashi/worksp/camera_ws/src/grasp_everything/grasp_everything/imaging_driver
```