# systemctlによる自動起動設定ガイド



Raspberry Pi起動時に `setup_cam_and_led.sh` を自動実行するための設定手順

  

---

  

## インストール手順

  

### 1. serviceファイルをsystemdディレクトリにコピー

  

```bash

sudo cp /home/hayashi-rpi/imaging_driver/run_imaging.service /etc/systemd/system/

```

  

### 2. systemdをリロード

  

```bash

sudo systemctl daemon-reload

```

  

### 3. 自動起動を有効化

  

```bash

sudo systemctl enable run_imaging.service

```

  

### 4. 今すぐ開始（テスト）

  

```bash

sudo systemctl start run_imaging.service

```

  

---

  

## Ctrl+Cの代わりの操作

  

| 手動実行時 | systemctl時 |

|-----------|-------------|

| `Ctrl+C` | `sudo systemctl stop run_imaging.service` |

  

---

  

## 動作の仕組み

  

- `systemctl stop` を実行すると、**SIGTERM** がスクリプトに送られます

- スクリプトは `trap cleanup EXIT TERM` で **SIGTERM** を捕捉しているので、LEDの停止処理が正しく実行されます

- `KillMode=mixed` により、メインプロセスにSIGTERM、子プロセスにもシグナルが送られます

  

---

  

## 便利なコマンド一覧

  

### ステータス確認

  

```bash

sudo systemctl status run_imaging.service

```

  

### ログ確認（リアルタイム）

  

```bash

$ sudo journalctl -u run_imaging.service -f

```

  

### ログ確認（全履歴）

  

```bash

$ sudo journalctl -u run_imaging.service

```

  

### サービス停止

  

```bash

$ sudo systemctl stop run_imaging.service

```

  

### サービス再起動

  

```bash

sudo systemctl restart run_imaging.service

```

  

### 自動起動無効化

  

```bash

sudo systemctl disable run_imaging.service

```

  

---

  

## serviceファイルの内容

  

`/home/hayashi-rpi/imaging_driver/run_imaging.service`

  

```ini

[Unit]

Description=Imaging service for LBM tactile sensing

After=multi-user.target network.target

  

[Service]

Type=simple

WorkingDirectory=/home/hayashi-rpi/imaging_driver

ExecStart=/home/hayashi-rpi/imaging_driver/bash_scripts/setup_cam_and_led.sh

ExecStop=/bin/kill -TERM $MAINPID

Restart=on-failure

RestartSec=5

KillMode=mixed

KillSignal=SIGTERM

TimeoutStopSec=10

StandardOutput=journal

StandardError=journal

User=hayashi-rpi

  

[Install]

WantedBy=multi-user.target

```

  

### 各設定の説明

  

| 設定 | 説明 |

|------|------|

| `Type=simple` | ExecStartで指定したプロセスがメインプロセス |

| `KillMode=mixed` | メインプロセスにSIGTERM、子プロセスにSIGKILL |

| `KillSignal=SIGTERM` | 停止時にSIGTERMを送信 |

| `Restart=on-failure` | 異常終了時に自動再起動 |

| `RestartSec=5` | 再起動まで5秒待機 |

| `TimeoutStopSec=10` | 停止処理のタイムアウト10秒 |

  

---

  

## トラブルシューティング

  

### サービスが起動しない場合

  

```bash

# 詳細なエラーログを確認

sudo journalctl -u run_imaging.service -n 50 --no-pager

  

# serviceファイルの構文チェック

sudo systemd-analyze verify /etc/systemd/system/run_imaging.service

```

  

### LEDが正しく停止しない場合

  

```bash

# LEDプロセスを手動で確認

ps aux | grep ws2812

  

# 手動で停止

sudo pkill -f ws2812.py

```

  

### 設定変更後

  

serviceファイルを編集した後は、必ず以下を実行：

  

```bash

sudo systemctl daemon-reload

sudo systemctl restart run_imaging.service

```